<%- include('../partials/user/header') %>


<style>
    .edit-img-link:hover{
        text-decoration: underline;
    }
    .logout-option:hover{
        background-color: rgb(196, 3, 3);
        color: white;
    }
    .logout-option button:hover{
        background-color: none;
    }
</style>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Pages
                    <span></span> Account
                </div>
            </div>
        </div>
        <h1 class="p-5 ms-5">User Dashboard</h1>
        <section class="pt-50 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>My Profile</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orderTab" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>My Orders</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/wallet"><i class="fi-rr-wallet mr-10"></i>My Wallet</a>
                                        </li>
                                       
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <form action="/logout" class=" logout-option" method="post">
                                            <button type="submit" style="background: none;border: none;">
                                        <li class="nav-item">
                                            <a class="nav-link"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                        </button>
                                        </form>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">

                                    <!-- order partial -->
                                    <div class="tab-pane fade" id="orderTab" role="tabpanel" aria-labelledby="orders-tab">
                                        <div class="content-header p-1">
                                               <h2>Your Orders</h2>
                                          </div>
                                           
                                        <div class="card">
                                            <div class="card-header">
                                                <form id="filterForm" class="row g-3 align-items-center ">
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="row g-2 align-items-center">
                                                        
                                                        <div class="col-auto">
                                                            <input type="text" placeholder="Search by Order ID " 
                                                            class="form-control" name="search" id="searchInput" value="">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                        <div class="row g-2 align-items-center">
                                                          
                                                            <div class="col-auto">
                                                               <input type="date" name="orderDate" style="max-width: 180px;min-width: 140px;" class="form-control form-control-sm" id="orderDateInput">
                                                        </div>
                                                        </div>
                                                    </div>
                                                <div class="col-auto">
                                                        <div class="row g-2 align-items-center">
                                                          
                                                            <div class="col-auto">
                                                               <select name="orderStatusDropdown" class="form-select status-dropdown" id="orderStatus">
                                                                <option value="All" selected>Order Status</option>
                                                                <option value="Paid">Paid</option>
                                                                <option value="Processing">Processing</option>
                                                                <option value="Shipped">Shipped</option>
                                                                <option value="Delivered">Delivered</option>
                                                                <option value="Return Requested">Return Requested</option>
                                                                <option value="Cancelled">Cancelled</option>
                                                               </select>
                                                        </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-auto d-flex align-items-center gap-2">
                                                            <button type="btn" class="btn" hidden id="clearOrderFilterBtn"><i class="fi-rs-cross"></i></button>
                                                            <button type="submit" id="submitFormBtn" class="btn order-filter-btn"><i class="fi-rs-search"></i></button>
                                                    
                                                    </div>
                                                      
                                                </form>
                                            </div>
                                            <div id="orders">
                                                <%-include('../partials/user/orderList')  %>
                                            </div>
                                        </div>

                                    <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>My Addresses</h5>
                                            <button class="btn btn-primary" id="addAddressBtn" data-bs-toggle="modal" data-bs-target="#addressModal">Add New</button>
                                        </div>
                                        <div class="row" id="addressListContainer">
                                            <% if(user.addresses && user.addresses.length>0){ %>
                                                <% user.addresses.forEach((address,i) => { %>
                                                    <div class="col-lg-6">
                                                        <div class="card mb-3 mb-lg-0">
                                                            <div class="card-header">
                                                                <h5 class="mb-0">Address <%=i+1%></h5>
                                                            </div>
                                                        
                                                            <div class="card-body">
                                                                <strong><%=address.name%></strong><br>
                                                                <address><%=address.street%>,<br><%=address.city%><br><%=address.state%>,<%=address.pinCode%></address>
                                                                <button class="btn btn-secondary btn-sm edit-address-btn" data-address-id="<%=address._id%>" data-bs-toggle="modal" data-bs-target="#addressModal">Edit</button>
                                                                <button class="btn btn-danger btn-sm delete-address-btn" data-address-id="<%=address._id%>">Delete</button>
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                <% }) %>
                                                <% }else{ %>
                                                    <p>You have no saved addresses</p>
                                                    <%}%>
                                        </div>
                                        
                                    </div>
                                    
                                    <div class="modal fade" id="addressModal" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="addressModalTitle">Add Address</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="addressForm">
                                                        <input type="hidden" name="addressId" id="addressId">
                                                        <div class="mb-3">
                                                            <label for="name" class="form-label">Full Name</label>
                                                            <input type="text" name="name" id="name" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="street" class="form-label">Street</label>
                                                            <input type="text" name="street" id="street" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="city" class="form-label">City</label>
                                                            <input type="text" name="city" id="city" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="state" class="form-label">State</label>
                                                            <input type="text" name="state" id="state" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="pincode" class="form-label">Pincode</label>
                                                            <input type="number" name="pinCode" id="pincode" required>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary" form="addressForm">Save Changes</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal fade" id="editProfileModal" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editProfileModalTitle">Edit Account</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="editProfileForm" action="/account/update">
                                                        <div class="mb-3">
                                                            <label for="name" class="form-label">Full Name</label>
                                                            <input type="text" name="name" id="username">
                                                            <p id="name-error" style="color: red;"></p>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="phone" class="form-label">Phone Number</label>
                                                            <input type="text" name="phone" id="userphone">
                                                            <p id="phone-error" style="color: red;"></p>
                                                        </div>
                                                        
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary" form="editProfileForm" id="editProfileSub">Save Changes</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade active show" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Account Details</h5>
                                            </div>
                                            <div class="card-body">
                                                <form method="post" name="enq" id="userDetailsForm">
                                                    <div class="row">
                                                        <div class="user-img-container d-flex justify-content-center">
                                                            <img src="<%= user.profileImage?user.profileImage:'/images/defaultImage.jpg' %>" id="user-image" alt="user_image" style="border-radius: 50%;" width="150px" height="150px">
                                                        </div>
                                                        <div class="edit-img-container d-flex justify-content-center">
                                                            <a href="#" id="img-edit-btn" class="edit-img-link">Edit Image <i class="fa fa-edit"></i></a>
                                                        </div>
                                                        <div class="form-group col-md-4">
                                                            <label>Name</label>
                                                            <input required="" id="displayName" class="form-control square" name="name" type="text" readonly value="<%= user.name%>">
                                                        </div>
                                                        
                                                        <div class="form-group col-md-4">
                                                            <label>Email Address</label>
                                                            <input required="" class="form-control square" name="email" type="email" value="<%= user.email %>" readonly>
                                                            <a href="/edit/email">Change Email <i class="fa fa-edit"></i></a>
                                                        </div>
                                                        <div class="form-group col-md-4">
                                                            <label>Phone</label>
                                                            <input required="" id="displayPhone" class="form-control square" name="phone" type="text" readonly value="<%= user.phone %>">
                                                        </div>
                                                       
                                                        <div class="col-md-12">
                                                            <button type="button" class="btn btn-secondary btn-sm edit-profile-btn" data-account-id="<%=user._id%>" data-bs-toggle="modal" id="editProfileBtn" data-bs-target="#editProfileModal">Edit User Details</button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <%- include("../partials/user/footer") %>
    <!-- Preloader Start -->
    <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/frontend/assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="/frontend/assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="/frontend/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="/frontend/assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="/frontend/assets/js/plugins/slick.js"></script>
    <script src="/frontend/assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="/frontend/assets/js/plugins/wow.js"></script>
    <script src="/frontend/assets/js/plugins/jquery-ui.js"></script>
    <script src="/frontend/assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="/frontend/assets/js/plugins/magnific-popup.js"></script>
    <script src="/frontend/assets/js/plugins/select2.min.js"></script>
    <script src="/frontend/assets/js/plugins/waypoints.js"></script>
    <script src="/frontend/assets/js/plugins/counterup.js"></script>
    <script src="/frontend/assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="/frontend/assets/js/plugins/images-loaded.js"></script>
    <script src="/frontend/assets/js/plugins/isotope.js"></script>
    <script src="/frontend/assets/js/plugins/scrollup.js"></script>
    <script src="/frontend/assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="/frontend/assets/js/plugins/jquery.theia.sticky.js"></script>
    <!-- Template  JS -->
    <script src="/frontend/assets/js/main.js?v=3.4"></script>

<script>
    document.addEventListener('DOMContentLoaded',function() {
        //User ProfileImage management

        //User Address Management
        const addressListContainer=document.getElementById('addressListContainer')
        const addressModal=new bootstrap.Modal(document.getElementById('addressModal'))
        const addressForm=document.getElementById('addressForm')
        const addressModalTitle=document.getElementById('addressModalTitle')

        function renderAddresses(addresses) {
            addressListContainer.innerHTML=""
            if(addresses.length===0){
                addressListContainer.innerHTML='<p>You have no saved addresses</p>'
                return
            }
            addresses.forEach((address,i)=> {
                const addressCard=`
                <div class="col-lg-6 mb-3">
                    <div class="card-header">
                    <h5 class="mb-0">Address ${i+1}</h5>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <strong>${address.name}</strong><br>
                            ${address.street}<br>
                            ${address.city}, ${address.state} ${address.pinCode}<br>
                            
                            <hr>
                            <button class="btn btn-secondary btn-sm edit-address-btn" data-address-id="${address._id}" data-bs-toggle="modal" data-bs-target="#addressModal">Edit</button>
                            <button class="btn btn-danger btn-sm delete-address-btn" data-address-id="${address._id}">Delete</button>
                        </div>
                    </div>
                </div>
                `
                addressListContainer.innerHTML+=addressCard
            });
        }
        //handle clicks on "Add New","Edit","Delete"
        addressListContainer.addEventListener('click',async(event)=>{
            const target=event.target

            //if editbutton
            if(target.classList.contains('edit-address-btn')){
                const addressId=target.dataset.addressId
                addressForm.reset()
                addressModalTitle.textContent='Edit Address'

                //fetch for specific address
                const response=await fetch(`/account/addresses/${addressId}`)
                const result=await response.json()

                if(result.success){
                    document.getElementById('addressId').value=result.address._id
                    document.getElementById('name').value=result.address.name
                    document.getElementById('street').value=result.address.street
                    document.getElementById('city').value=result.address.city
                    document.getElementById('state').value=result.address.state
                    document.getElementById('pincode').value=result.address.pinCode
                }
            }
            //if deleteButton
            if(target.classList.contains('delete-address-btn')){
                const addressId=target.dataset.addressId
                Swal.fire({
                    icon:'warning',
                    title:'Are You Sure?',
                    text:'Do you want to delete this address',
                    showCancelButton:true,
                    confirmButtonText:'Yes!Delete it'
                }).then(async(result)=>{
                    if(result.isConfirmed){
                        const response=await fetch(`/account/addresses/${addressId}`,{method:'DELETE'})
                    const result=await response.json()
                    if(result.success){
                        renderAddresses(result.addresses)//re-render the list
                    }
                    }
                })
            }
        })
        //add new address button
        document.getElementById('addAddressBtn').addEventListener('click',()=>{
            addressForm.reset()
            addressModalTitle.textContent='Add New Address'
            document.getElementById('addressId').value=''//clear ID for add mode
        })

        //handle the modal form submission for both ADD and EDIt
        addressForm.addEventListener('submit',async(event)=>{
            event.preventDefault()
            const addressId=document.getElementById('addressId').value
            const formData=new FormData(addressForm)
            const data=Object.fromEntries(formData.entries())

            const isEditing=!!addressId
            const url=isEditing?`/account/addresses/${addressId}`:`/account/addresses`
            const method=isEditing?'PUT':'POST'

            const response=await fetch(url,{
                method:method,
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(data)
            })
            const result=await response.json()
            if(result.success){
                renderAddresses(result.addresses)
                addressModal.hide();
            }
        })

        //edit form calling and populate
        const editbtn=document.getElementById('editProfileBtn')
        const editModal=new bootstrap.Modal(document.getElementById('editProfileModal'))//to manipulate the modal
        const userId=editbtn.dataset.accountId
        editbtn.addEventListener('click',async()=>{
            console.log("editbtn clicked")
            // console.log("userId :",userId)
            const response=await fetch(`/account/editProfile/${userId}`,{
                method:'GET',
                headers:{'Content-Type':'application/json'},
            })
            const result=await response.json()
        const username=document.getElementById('username')
        const userphone=document.getElementById('userphone')
        userphone.value=result.phone
        username.value=result.name
        })
        const editform=document.getElementById('editProfileForm')

       editform.addEventListener('submit',function(e){
        e.preventDefault()
            const formData=new FormData(editform)
            const name=formData.get('name')
            const phone=formData.get('phone')
            let isValid=true
            const phoneError=document.getElementById('phone-error')
            const nameError=document.getElementById('name-error')

            if(name.trim()===""){
                    nameError.textContent="*Please enter a valid name"
                    isValid=false
            }
            const phoneRegex=/^\d{10}$/
            if(!phoneRegex.test(phone)){
                phoneError.textContent="*Please enter a valid phone number"
                isValid=false
            }
            if(isValid){
                const data=Object.fromEntries(formData.entries())
                fetch(editform.action,{
                    method:"PUT",
                    headers:{"Content-Type":"application/json"},
                    body:JSON.stringify(data)
                }).then(response=>response.json())
                .then(result=>{
                    if(result.success){
                        Swal.fire({
                            icon:'success',
                            title:'Success',
                            text:result.message,
                            timer:1000,
                            showConfirmButton:false
                        }).then(()=>{
                            editModal.hide()//close the modal after swal
                            document.getElementById('displayName').value=data.name
                            document.getElementById('displayPhone').value=data.phone
                        })
                    }else{
                        Swal.fire({
                            icon:'error',
                            title:'Error',
                            text:result.message
                        })
                    }
                })
                .catch(error=>{
                    console.log("error in editing",error)
                    Swal.fire({
                            icon:'error',
                            title:'Server Error',
                            text:error.message
                        })
                })
            }else{
                e.preventDefault()
            }
                 
               
        })
        //image handling
        document.getElementById('img-edit-btn').addEventListener('click',function(e){
            e.preventDefault()
            Swal.fire({
                title:'Edit Image',
                icon:'question',
                text:'Would you like to remove your profile picture or change it',
                showCancelButton:true,
                confirmButtonText:'Change Image',
                cancelButtonText:'Remove Image',
                reverseButtons:true
            }).then((result)=>{
                if(result.isConfirmed){
                    window.location.href='/account/change-image'
                }else if(result.dismiss===Swal.DismissReason.cancel){
                    fetch('/account/change-image',{
                        method:'DELETE',
                        headers:{"Content-Type":"application/json"}
                    }).then(res=>res.json())
                    .then(data=>{
                        if(data.success){
                            Swal.fire('Removed Image!','Your image has been removed','success')
                            .then(()=>location.reload());
                        }else{
                            Swal.fire('Error',data.message||'Could not remove image','error')
                        }
                    })
                }
            })
        })

        
        //orders page & search
        const orderContainer=document.getElementById('orders')
        const orderFilterForm=document.getElementById('filterForm')
        const searchInput=document.getElementById('searchInput')
        const dateInput=document.getElementById('orderDateInput')
        const statusField=document.getElementById('orderStatus')
        const submitBtn=document.getElementById('submitFormBtn')
        const clearFilterBtn=document.getElementById('clearOrderFilterBtn')
        async function fetchOrders(page=1) {
            const search=searchInput.value.trim()
            const date=dateInput.value
            const status=statusField.value

            const urlParams=new URLSearchParams({search,date,status,page})
            const url=`/order/search?${urlParams}`
            try{
            const response=await fetch(url,{
                headers:{'X-Requested-With':'XMLHttpRequest'},
            })
            if(!response.ok)throw new Error('Network issue in fetching orders')
            const html=await response.text()
        
        orderContainer.innerHTML=html
        // window.history.pushState({},'',url)
            }catch(error){
                console.error("error in fetching orders: ",error);
                Swal.fire("Error!",error||"Server Error","error")
            } 
        }
        //fetch orders
        orderFilterForm.addEventListener('submit',async function(e){
            e.preventDefault()
            fetchOrders(1)
            clearFilterBtn.removeAttribute('hidden')


        })
        //clear filter
        clearFilterBtn.addEventListener('click',async function (e) {
            searchInput.value=''
            dateInput.value=''
            statusField.value='All'
            e.preventDefault()
            fetchOrders(1)
            clearFilterBtn.setAttribute('hidden',true)            
        })
        //pagination logic
        if(orderContainer){
           
            
            orderContainer.addEventListener('click',function(e){
               const link=e.target.closest('.page-link')
               
               if(!link)return
               e.preventDefault()
               const page=link.getAttribute('data-page')
               console.log("page link: ",page);
               if(page){
                fetchOrders(page)
               }
            })
        }
    })
    </script>
</body>

</html>