<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Change Profile Image</title>
  <link rel="stylesheet" href="/frontend/assets/css/main.css?v=3.4"> <!-- Your CSS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <!--cropperjs script-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
 <div class="container mt-5">
  <h2 class="text-center mb-4">Change Your Profile Image</h2>

  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <form id="imageUploadForm" enctype="multipart/form-data" class="text-center p-4 border rounded bg-light shadow-sm">
        
        <div class="mb-3">
          <label for="profileImage" class="form-label">Select New Image</label>
          <input type="file" class="form-control" name="profileImage" id="profileImage" accept="image/*" required>
        </div>

        <div class="mb-3 d-flex justify-content-center">
          <img id="preview" src="#" alt="Preview" style="display:none; border-radius:50%; width:200px; height:200px;">
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary">Upload Image</button>
        </div>
        
      </form>
    </div>
  </div>
</div>
 <div class="modal fade" id="cropModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Crop Your Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <img id="imageToCrop" src="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="cropButton">Crop</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
    const input = document.getElementById('profileImage')
    const preview = document.getElementById('preview')
    const imageToCrop=document.getElementById('imageToCrop')
    const cropButton=document.getElementById('cropButton')
    const cropModalElement=document.getElementById('cropModal')
    const uploadForm=document.getElementById('imageUploadForm')
    
    const cropModal=new bootstrap.Modal(cropModalElement)
 
    
    
    let cropper
    let croppedImageBlob=null//to store the final cropped image data
    
    //to handle file selection
    input.addEventListener('change', function (e) {
      const file = e.target.files[0]
      if (!file) return
        const reader = new FileReader()
        reader.onload = function (event) {
            //for setting the modal's image source
            imageToCrop.src=event.target.result
            cropModal.show()
        }
        reader.readAsDataURL(file)
      
    });
    //initialize cropper when modal is shown
    document.getElementById('cropModal').addEventListener('shown.bs.modal',function(){
        //destroys old cropper if its there
        if(cropper){
            cropper.destroy()
        }
        //make a new cropper instance
        cropper=new Cropper(imageToCrop,{
            aspectRatio:1,
            viewMode:1,
            background:false
        })
    })
    //handle cropbtn click
    cropButton.addEventListener('click',function(){
        //get the cropped image as a canvvas
        const canvas=cropper.getCroppedCanvas({
            width:250,
            height:250,
        })
    
    //converts canvas to a Blob(binary data)
    canvas.toBlob(function (blob) {
    //store the blob for later upload
    croppedImageBlob=blob
    //Create a URL for the blob to show a preview
    const blobUrl=URL.createObjectURL(croppedImageBlob)
    preview.src=blobUrl
    preview.style.display='block'    
    },'image/jpeg')//mention the type of image should be, can be image/png also
    
    //Hide the modal after cropping
    cropModal.hide()
})
//handle final form submission
    uploadForm.addEventListener('submit', function (e) {
      e.preventDefault()
      //check if an image has been cropped
      if(!croppedImageBlob){
        Swal.fire('No Image!','Please select and crop an image first','warning')
        return
      }
      Swal.fire({
        title: 'Confirm Upload',
        text: 'Are you sure you want to change your profile image?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, upload it!',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          //sending result to the backend
          const formData=new FormData()
          //appending the blob to formData as a file
          formData.append('profileImage',croppedImageBlob,'profile.jpeg')
          
          //sending formData to backend
          fetch('/account/change-image',{
            method:'POST',
            body:formData,
          }).then(response=>response.json())
          .then(data=>{
            if(data.success){
                Swal.fire('Uploaded!','Your profile image has been changed','success').then(()=>window.location.href='/account')
            }else{
                Swal.fire('Error!','Something went wrong.','error')
            }
          })
          .catch(error=>{
            console.error('Profile image error: ',error);
            Swal.fire('Error!','Upload failed','error')
            
          })
        }
      })
    })
    })
  </script>
</body>
</html>