<%- include("../partials/user/header") %>

<section class="pt-50 pb-50">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 m-auto">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>My Wallet</h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center mb-50">
                            <div class="col-md-6">
                                <div class="p-4 bg-light rounded text-center">
                                    <h5 class="text-muted mb-2">Current Balance</h5>
                                    <% if(user.wallet.balance==0){ %>
                                    <h2 class="display-4 fw-bold" style="color: #088178;">₹0.00</h2>
                                    <% }else{ %>
                                    <h2 class="display-4 fw-bold" style="color: #088178;">₹<%= user.wallet.balance.toFixed(2) %></h2>
                                    <% } %>
                                </div>
                            </div>
                            <div class="col-md-6 mt-3 mt-md-0">
                                <div class="border p-4 rounded">
                                    <h5>Add Money to Wallet</h5>
                                    <div class="input-group mt-3">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" id="amount" class="form-control" placeholder="Enter Amount" min="1">
                                        <button class="btn btn-primary" id="addMoneyBtn">Recharge</button>
                                    </div>
                                    <small class="text-muted">Secured by Razorpay</small>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <h4 class="mb-3">Transaction History</h4>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Transaction Id</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (transactions.length > 0) { %>
                                        <% transactions.forEach(t => { %>
                                            <tr>
                                                <td><%= new Date(t.date).toLocaleDateString() %></td>
                                                <td><%= t.description %></td>
                                                <td>
                                                    <%=t.transactionId %>
                                                </td>
                                                <td>
                                                    <% if (t.type === 'Credit') { %>
                                                        <span class="badge bg-success">Credit</span>
                                                    <% } else { %>
                                                        <span class="badge bg-danger">Debit</span>
                                                    <% } %>
                                                </td>
                                                <td class="<%= t.type === 'Credit' ? 'text-success' : 'text-danger' %> fw-bold">
                                                    <% if(t.amount){ %>
                                                    <%= t.type === 'Credit' ? '+' : '-' %>₹<%= t.amount.toFixed(2) %>
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="4" class="text-center">No transactions yet.</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById('addMoneyBtn').addEventListener('click', async () => {
        const amount = document.getElementById('amount').value;
        if (!amount || amount < 1) {
            return Swal.fire('Error', 'Please enter a valid amount', 'error');
        }

        try {
            // 1. Create Order
            const response = await fetch('/wallet/add-money', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });
            const data = await response.json();

            if (!data.success) throw new Error(data.message);

            // 2. Open Razorpay
            const options = {
                "key": "<%= razorpayKeyId %>",
                "amount": data.order.amount,
                "currency": "INR",
                "name": "Ariane Motors User-Wallet",
                "description": "Wallet Recharge",
                "order_id": data.order.id,
                "handler": async function (response) {
                    // 3. Verify Payment
                    const verifyRes = await fetch('/wallet/verify-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            amount: amount
                        })
                    });
                    const verifyData = await verifyRes.json();
                    
                    if (verifyData.success) {
                        Swal.fire('Success', verifyData.message, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Error', verifyData.message, 'error');
                    }
                },
                "prefill": {
                    "name": "<%= user.name %>",
                    "email": "<%= user.email %>",
                    "contact": "<%= user.phone %>"
                },
                "theme": { "color": "#088178" }
            };
            const rzp = new Razorpay(options);
            rzp.open();

        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Something went wrong', 'error');
        }
    });
</script>

<%- include('../partials/user/footer') %>