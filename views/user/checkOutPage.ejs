<%-include("../partials/user/header") %>
<main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/user" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a href="#coupon" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md" name="login">Apply Coupon</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>Billing & Shipping Address</h4>
                        </div>
                        <% if(addresses && addresses.length>0) {%>
                            <div class="radio-btns d-flex justify-content-evenly">
                                <% addresses.forEach((addr,i)=>{ %>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="addressRadio" value="<%=i%>" id="addressRadio<%= i %>" <%= i==0?'checked':"" %>>
                                        <label class="form-check-label" for="addressRadio<%= i %>">Use Address <%=i+1 %></label>
                                    </div>
                                    <% }) %>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="addressRadio" value="new" id="addr-new">
                                        <label class="form-check-label" for="addr-new">Enter new Address</label>
                                    </div>
                                </div>
                                <% }else{%>
                                    <input type="hidden" name="addressRadio" value="new" checked>
                                    <p></p>
                                    <% } %>
                                    
                                    <form method="post" id="addressForm">
                            <div class="form-group">
                                <input type="text" required="" name="fname" id="name" placeholder="Name *" readonly>
                                <p style="color: red;" id="nameError"></p>
                            </div>
                            <div class="form-group">
                                <input type="text" name="street" required="" id="street" placeholder="Street/Line *" readonly>
                                <p style="color: red;" id="streetError"></p>
                            </div>
                            <div class="form-group">
                                <input required="" type="text" name="city" id="city" placeholder="City / Town *" readonly>
                                <p style="color: red;" id="cityError"></p>
                            </div>
                            <div class="form-group">
                                <input required="" type="text" name="state" id="state" placeholder="State*" readonly>
                                <p style="color: red;" id="stateError"></p>
                            </div>
                            <div class="form-group">
                                <input required="" type="text" name="zipcode" id="pinCode" placeholder="Postcode / PIN *" readonly>
                                <p style="color: red;" id="pinError"></p>
                            </div>
                            <button id="addAddressBtn" class="btn btn-primary" type="submit" hidden form="addressForm">Add Address</button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% cartItems.forEach(item => {%>
                                            
                                            <tr>
                                                <td class="image product-thumbnail"><img src="<%= item.productId.images[0] %>" alt="#"></td>
                                                <td>
                                                    <h5><a href="shop-product-full.html"><%= item.productId.name %></a></h5> <span class="product-qty">x <%= item.quantity %></span>
                                                    </td>
                                                    <% let subTotal=item.productId.price*item.quantity %>
                                                    <td>₹<%= subTotal %></td>
                                                    </tr>
                                                <%}); %>
                                        
                                        <tr>
                                            <th>SubTotal</th>
                                            <td class="product-subtotal" colspan="2">₹<%= totalPrice %></td>
                                        </tr>
                                        <tr>
                                            <th>Shipping</th>
                                            <td colspan="2"><em>Free Shipping</em></td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td colspan="2" class="product-subtotal"><span class="font-xl text-brand fw-900">₹<%= totalPrice.toFixed(2) %></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios3" checked="">
                                        <label class="form-check-label" for="exampleRadios3" data-bs-toggle="collapse" data-target="#bankTranfer" aria-controls="bankTranfer">Direct Bank Transfer</label>
                                        <div class="form-group collapse in" id="bankTranfer">
                                            <p class="text-muted mt-5">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios4" checked="">
                                        <label class="form-check-label" for="exampleRadios4" data-bs-toggle="collapse" data-target="#checkPayment" aria-controls="checkPayment">Check Payment</label>
                                        <div class="form-group collapse in" id="checkPayment">
                                            <p class="text-muted mt-5">Please send your cheque to Store Name, Store Street, Store Town, Store State / County, Store Postcode. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios5" checked="">
                                        <label class="form-check-label" for="exampleRadios5" data-bs-toggle="collapse" data-target="#paypal" aria-controls="paypal">Paypal</label>
                                        <div class="form-group collapse in" id="paypal">
                                            <p class="text-muted mt-5">Pay via PayPal; you can pay with your credit card if you don't have a PayPal account.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a href="#" class="btn btn-fill-out btn-block mt-30">Place Order</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
<%-include('../partials/user/footer') %>
<script>
    //selecting the address
    document.addEventListener('DOMContentLoaded',()=>{
       const addresses=<%-JSON.stringify(addresses||[]) %>
       
       
       const nameField=document.getElementById('name')
       const streetField=document.getElementById('street')
       const cityField=document.getElementById('city')
       const stateField=document.getElementById('state')
       const pinCode=document.getElementById('pinCode')

       const addAddressBtn=document.getElementById('addAddressBtn')
       //for populating the fields
       function populateForm(address) {
        if(!address)return
        nameField.value=address.name
        stateField.value=address.state
        streetField.value=address.street
        cityField.value=address.city
        pinCode.value=address.pinCode
       }

       //to clear the previous values from fields
       function clearForm() {
        nameField.value=""
        nameField.removeAttribute('readonly')
        streetField.value=""
        streetField.removeAttribute('readonly')
        cityField.value=""
        cityField.removeAttribute('readonly')
        stateField.value=""
        stateField.removeAttribute('readonly')
        pinCode.value=""
        pinCode.removeAttribute('readonly')
       }

       //event listeners on radios
       const radioBtns=document.querySelectorAll('input[name="addressRadio"]')
       radioBtns.forEach(btn=>{
        btn.addEventListener('change',(e)=>{
            const selectedValue=e.target.value
            
            if(selectedValue=='new'){
                clearForm()
                addAddressBtn.removeAttribute('hidden')
            }else{
                const index=parseInt(selectedValue)
                const selectedAddress=addresses[index]
                populateForm(selectedAddress)
                addAddressBtn.setAttribute('hidden',true)
            }
            
        })
    })
    //on initial page load
    const initiallyChecked=document.querySelector('input[name=addressRadio]:checked')
    if(initiallyChecked){
        const initialValue=initiallyChecked.value
        if(initialValue=='new'){
            clearForm()
            addAddressBtn.removeAttribute('hidden')
        }else{
            const initialIndex=parseInt(initialValue)
            const initialAddress=addresses[initialIndex]
            populateForm(initialAddress)
            addAddressBtn.setAttribute('hidden',true)
        }
       }else if(addresses.length===0){
        clearForm()
       }

       //submit add addressForm
       const addressForm=document.getElementById('addressForm')
       addAddressBtn.addEventListener('click',(e)=>{
        e.preventDefault()
        //validation
        let valid=true
        const name =nameField.value.trim()
        const street =streetField.value.trim()
        const city=cityField.value.trim()
        const state =stateField.value.trim()
        const pin=pinCode.value.trim()
        document.getElementById('nameError').textContent=''
        document.getElementById('streetError').textContent=''
        document.getElementById('cityError').textContent=''
        document.getElementById('stateError').textContent=''
        document.getElementById('pinError').textContent=''
        
        if(name==""||name==undefined){
            document.getElementById('nameError').textContent="*Enter a valid name"
            valid=false
        }
        if(street==""||street==undefined){
            document.getElementById('streetError').textContent="*Enter a valid street name"
            valid=false
        }
        if(city==""||city==undefined){
            document.getElementById('cityError').textContent="*Enter a valid city name"
            valid=false
        }
        if(state==""||state==undefined){
            document.getElementById('stateError').textContent="*Enter a valid state"
            valid=false
        }
        const numberRegex=/^\d+$/
        if(typeof(parseInt(pin))!="number"||pin.length!==6||numberRegex.test(pin)){
                document.getElementById('pinError').textContent="*Pin should have 6 digits & Must not contain alphabets"
            
            valid=false
        }
        const formData=new FormData(addressForm)
        
        const data=Object.fromEntries(formData.entries())
        console.log(data);
       })
    })
</script>