<%-include("../partials/user/header") %>

<!-- Load Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/user" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <% if(cartItems&&cartItems.length>0) {%>
                <div class="row">
                    
                   
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>Billing & Shipping Address</h4>
                        </div>
                        <% if(addresses && addresses.length>0) {%>
                            <div class="radio-btns d-flex justify-content-evenly">
                                <% addresses.forEach((addr,i)=>{ %>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="addressRadio" value="<%=i%>" id="addressRadio<%= i %>" <%= i==0?'checked':"" %>>
                                        <label class="form-check-label" for="addressRadio<%= i %>">Use Address <%=i+1 %></label>
                                    </div>
                                    <% }) %>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="addressRadio" value="new" id="addr-new">
                                        <label class="form-check-label" for="addr-new">Enter new Address</label>
                                    </div>
                                </div>
                                <% }else{%>
                                    <input type="radio" hidden name="addressRadio" value="new" checked>
                                    <h3>Enter an address</h3>
                                    <% } %>
                                    
                                    <form method="post" id="addressForm">
                            <div class="form-group">
                                <input type="text" class="text-white" style="background-color: #088178;" required="" name="name" id="name" placeholder="Name *" readonly>
                                <p style="color: red;" id="nameError"></p>
                            </div>
                            <div class="form-group">
                                <input type="text" class="text-white" style="background-color: #088178;" name="street" required="" id="street" placeholder="Street/Line *" readonly>
                                <p style="color: red;" id="streetError"></p>
                            </div>
                            <div class="form-group">
                                <input required="" class="text-white" style="background-color: #088178;" type="text" name="city" id="city" placeholder="City / Town *" readonly>
                                <p style="color: red;" id="cityError"></p>
                            </div>
                            <div class="form-group">
                                <input required="" class="text-white" style="background-color: #088178;" type="text" name="state" id="state" placeholder="State*" readonly>
                                <p style="color: red;" id="stateError"></p>
                            </div>
                            <div class="form-group">
                                <input required="" class="text-white" style="background-color: #088178;" type="text" name="pinCode" id="pinCode" placeholder="Postcode / PIN *" readonly>
                                <p style="color: red;" id="pinError"></p>
                            </div>
                            <div class="error-messages">
                            </div>
                            <button id="addAddressBtn" class="btn btn-primary" type="submit" hidden form="addressForm">Add Address</button>
                        </form>
                        <br>
                        <h5 class="p-2">You can edit your addresses in <a href="/account" style="text-decoration: underline;">Your Profile</a></h5>
                        <div class="form-group">
                            <input class="text-white" style="background-color: #088178;" type="text" name="country" id="country" placeholder="Country" value="India">
                        </div>
                        <div class="form-group">
                            <input class="text-white" style="background-color: #088178;" type="text" name="phone" id="phone" placeholder="Phone" value="<%=user.phone %>">
                        </div>
                        <div class="form-group">
                            <input class="text-white" style="background-color: #088178;" type="text" name="email" id="email" placeholder="Email" value="<%= user.email %>">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="order_review">
                                <div class="mb-30 mt-50">
                                    <div class="heading_s1 mb-3">
                                        <h4>Apply Coupon</h4>
                                    </div>
                                    <div class="total-amount">
                                        <div class="left">
                                            <div class="coupon">
                                                <form action="#" target="_blank">
                                                    <div class="form-row row justify-content-center">
                                                        <div class="form-group">
                                                            <input class="font-medium" name="coupon" id="couponInput" placeholder="Enter Your Coupon">
                                                        </div>
                                                        <div class="form-group">
                                                            <button class="btn  btn-sm" id="applyBtn"><i class="fi-rs-label mr-10"></i>Apply</button>
                                                            <button type="button" class="btn-warning btn-outline-secondary btn-sm" id="showCouponsBtn"><i class="fi-rs-label mr-10"></i>Available Coupons</button>
                                                        </div>
                                                    </div>
                                                </form>
                                                <p id="couponMessage" class="small mt-2"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table no-border">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% cartItems.forEach(item => {%>
                                            
                                            <tr>
                                                <td class="image product-thumbnail"><img src="<%= item.productId.images[0] %>" alt="#"></td>
                                                <td>
                                                    <h5><a href="/shop/product/<%=item.productId._id%>"><%= item.productId.name %></a></h5> <span class="product-qty">x <%= item.quantity %></span>
                                                    </td>
                                                    <% let subTotal=item.productId.price*item.quantity %>
                                                    <td>₹<%= subTotal %></td>
                                                    </tr>
                                                <%}); %>
                                        
                                        <tr>
                                            <th>SubTotal</th>
                                            <td class="product-subtotal" colspan="2">₹<%= totalPrice %></td>
                                        </tr>
                                        <tr>
                                            <th>Shipping</th>
                                            <td colspan="2"><em>Free Shipping</em></td>
                                        </tr>
                                        <tr id="discountRow" style="display: none;">
                                            <th class="cart_total_label">Coupon Discount <span id="appliedCodeBadge" class="badge bg-success ml-2"></span> 
                                                <a href="#" id="removeCouponBtn" class="text-danger small ml-2">
                                                    <i class="fi-rs-cross-small"></i>
                                                </a>
                                            </th>
                                            <td colspan="2" class="cart_total_amount"> <i class="ti-gift"></i>
                                                 -₹<span class="font-lg fw-900 text-brand" id="discountAmount">0.00</span>
                                                </td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td colspan="2" class="product-subtotal"><span id="totalSpan" class="font-xl text-brand fw-900">₹<%= totalPrice.toFixed(2) %></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!--Coupon Modal-->
                            <div class="modal fade" id="couponModal" tabindex="-1">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Available Coupons</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <% if(coupons && coupons.length>0) {%>
                                                <% coupons.forEach(coupon=>{ %>
                                                    <div class=" card mb-2 border-dashed ">
                                                        <div class="card-body ">
                                                            <h6 class="mb-1"><%= coupon.code %></h6>
                                                            <% if(coupon.discountType=='fixed'){ %>
                                                            <small class="text-muted">Get a discount of ₹<%=coupon.discountValue%> for a minimum purchase of ₹<%=coupon.minPurchaseAmount%></small>
                                                            <% }else{ %>
                                                                <small class="text-muted">Get a discount of <%=coupon.discountValue%>% off on a minimum purchase of ₹<%=coupon.minPurchaseAmount%></small>
                                                                <% } %>
                                                        </div>
                                                        <button class="btn btn-sm btn-light copy-button" data-code="<%=coupon.code%>">Copy</button>
                                                    </div>
                                                    <% }) %>
                                                <% }else{ %>
                                                    <p class="text-center text-muted">No Coupons available</p>
                                                    <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" value="Online" id="paymentOptionOnline" checked>
                                        <label class="form-check-label" for="paymentOptionOnline">Online Payment</label>
                                    </div>
                                     <div class="custome-radio">
                                        <input class="form-check-input" required type="radio" name="payment_option" value="Wallet" id="paymentOptionWallet" >
                                        <label class="form-check-label" for="paymentOptionWallet">Use Wallet</label>
                                        <small class="text-muted">Wallet balance: ₹<%=walletBalance%></small>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="paymentOptionCOD" value="COD">
                                        <label class="form-check-label" for="paymentOptionCOD">Cash on Delivery</label>
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="error-message">
                                <p class="text-danger" id="errorMsg"></p>
                            </div>
                            <a href="#" class="btn btn-fill-out btn-block mt-30" id="placeOrderButton">Make Payment</a>
                        </div>
                         <!-- Message area for success/error -->
        <div id="payment-message" class="mt-4 text-center"></div>
                    </div>
                </div>
                <% }else{ %>

                    <h3 style="color: #088178;text-align: center;" class="justify-content-center">No available items in cart purchase. Please check the availability of products before checkout</h3>
                    <div class="d-flex justify-content-center p-30">
                        <a class="btn btn-primary me-2" href="/shop/cart">Go to Cart</a>
                        <a class="btn btn-primary" href="/shop/products">Continue Shopping</a>
                    </div>
                    <% } %>
            </div>
        </section>
    </main>
<%-include('../partials/user/footer') %>
<script>
    //selecting the address
    document.addEventListener('DOMContentLoaded',()=>{
       const addresses=<%-JSON.stringify(addresses||[]) %>
       
       
       
       const nameField=document.getElementById('name')
       const streetField=document.getElementById('street')
       const cityField=document.getElementById('city')
       const stateField=document.getElementById('state')
       const pinCode=document.getElementById('pinCode')

       const addAddressBtn=document.getElementById('addAddressBtn')
       
       const fields={
        name:nameField,
        street:streetField,
        city:cityField,
        state:stateField,
        pinCode:pinCode
       }
       //for populating the fields
       function populateForm(address) {
        if(!address)return
        Object.entries(fields).forEach(([key,field])=>{
            field.value=address[key]
            field.classList.add('text-white')
            field.setAttribute('readonly','')
            field.style.backgroundColor='#088178'
        })
       }

       //to clear the previous values from fields
       function clearForm() {
         Object.values(fields).forEach(field=>{
                field.removeAttribute('style')
                field.removeAttribute('readonly')
                field.value=''
                field.className=''
        
    })
       }

       //event listeners on radios
       const radioBtns=document.querySelectorAll('input[name="addressRadio"]')
       radioBtns.forEach(btn=>{
        btn.addEventListener('change',(e)=>{
            const selectedValue=e.target.value
            
            if(selectedValue=='new'){
                clearForm()
                addAddressBtn.removeAttribute('hidden')
            }else{
                const index=parseInt(selectedValue)
                const selectedAddress=addresses[index]
                populateForm(selectedAddress)
                addAddressBtn.setAttribute('hidden',true)
                  document.getElementById('nameError').textContent=''
        document.getElementById('streetError').textContent=''
        document.getElementById('cityError').textContent=''
        document.getElementById('stateError').textContent=''
        document.getElementById('pinError').textContent=''
            }
            
        })
    })
    //on initial page load
    const initiallyChecked=document.querySelector('input[name=addressRadio]:checked')
    if(initiallyChecked){
        const initialValue=initiallyChecked.value
        if(initialValue=='new'){
            clearForm()
            addAddressBtn.removeAttribute('hidden')
        }else{
            const initialIndex=parseInt(initialValue)
            const initialAddress=addresses[initialIndex]
            populateForm(initialAddress)
            addAddressBtn.setAttribute('hidden',true)
        }
       }else if(addresses.length===0){
        clearForm()
       }

       //submit add addressForm
       const addressForm=document.getElementById('addressForm')
       addAddressBtn.addEventListener('click',async(e)=>{
        e.preventDefault()
        //Adding new address
        const errorContainer=document.querySelector('.error-messages')
        const formData=new FormData(addressForm)
        
        const data=Object.fromEntries(formData.entries())
        console.log(data);
        const url=`/account/addresses`
        try {
            const response =await fetch(url,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(data)
            })
            const result=await response.json()
            if(!response.ok){
                if(response.status==400 &&result.errors){
                    const errorMessages=result.errors.map(err=>err.msg).join('\n*')
                    const p=document.createElement('p')
                    p.classList.add('text-danger')
                    p.innerText=errorMessages
                    errorContainer.appendChild(p)
            
                    Swal.fire('Validation error!','Please validate your entries','error')
                }else{
                    Swal.fire('Error!',result.message,'error')
                }
                return
            }
            if(result.success){
                await Swal.fire("Success!",result.message,'success').then(()=>{
                    location.reload()
                })
            }else{
                Swal.fire("Error!",result.message,'error')
            }
        } catch (error) {
            Swal.fire("Error!",error.message,'Unexpected Error Occurred')
        }
        
       })
       //changing button text on payment option
       const placeOrderBtn=document.getElementById('placeOrderButton')
       const paymentMessage=document.getElementById('payment-message')
       const paymentOptions=document.querySelectorAll('input[name="payment_option"]')
       paymentOptions.forEach(radio=>{
        radio.addEventListener('change',()=>{
            console.log("radio clicked: ",radio.value);
            
            if(radio.value==='Online'||radio.value=='Wallet'&&radio.checked){
                placeOrderBtn.textContent='Make Payment'
            }else if(radio.checked&&radio.value==='COD'){
                placeOrderBtn.textContent='Place Order'
            }
        })
       })
        //coupon management
        const discountRow=document.getElementById('discountRow')
        const discountDisplay=document.getElementById('discountAmount')
        const totalDisplay=document.getElementById('totalSpan')
        const applyCouponBtn=document.getElementById('applyBtn')
        const removeCpnBtn=document.getElementById('removeCouponBtn')
        const couponMessage=document.getElementById('couponMessage')
        const showCouponsBtn=document.getElementById('showCouponsBtn')
        const couponInput=document.getElementById('couponInput')
        //apply coupon
        let appliedCopounCode=null
        applyCouponBtn.addEventListener('click',async(e)=>{
            // applyCouponBtn.disabled=true
            e.preventDefault()
            let code=couponInput.value.trim()
            console.log("coupon input: ",code)
            if(!code)return Swal.fire('Error!','Please enter a proper coupon','error')
            applyCouponBtn.disabled=true
            applyCouponBtn.innerText='Checking..'
        try {
            const response=await fetch('/shop/checkout/applyCoupon',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    couponCode:code,
                    totalAmount:totalPrice
                })
            })
            if(!response.ok) throw new Error("Network issue in Applying coupon");
            const result=await response.json()
            if(result.success){
                appliedCopounCode=result.code
                discountRow.style.display='table-row'
                discountDisplay.innerText="₹"+result.discount.toFixed(2)
                totalDisplay.innerText="₹"+result.totalAmount.toFixed(2)
                totalPrice=result.totalAmount
                applyCouponBtn.disabled=true
                showCouponsBtn.disabled=true
                applyCouponBtn.innerText='Coupon Applied!'
                couponMessage.className='small mt-2 text-success'
                couponMessage.innerText=result.message
                Swal.fire({
                    icon:'success',
                    title:`${result.code} Applied!`,
                    text:result.message
                })

            }else{
                couponMessage.className='small mt-2 text-danger'
                couponMessage.innerText=result.message
                Swal.fire('Error!',result.message,'error')
                applyCouponBtn.disabled=false
                applyCouponBtn.innerText='Apply'
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error','Something went wrong!','error')
        }
        
        })
        //show available coupons
        const modalElement=new bootstrap.Modal(document.getElementById('couponModal'))
        showCouponsBtn.addEventListener('click',()=>{
            modalElement.show()
        })
        const copyBtns=document.querySelectorAll('.copy-button')
        copyBtns.forEach(btn=>{
            btn.addEventListener('click',function(){
                const code=this.getAttribute('data-code')
                couponInput.value=code
                modalElement.hide()
            })
        })
        //remove coupon
        if(removeCpnBtn){
            removeCpnBtn.addEventListener('click',async(e)=>{
                e.preventDefault()
                discountRow.style.display='none'
                totalDisplay.innerText='₹'+ogTotalPrice.toFixed(2)
                appliedCopounCode=null
                totalPrice=ogTotalPrice
                applyCouponBtn.disabled=false
                showCouponsBtn.disabled=false
                applyCouponBtn.innerText='Apply'
                couponMessage.innerText=''
                couponInput.value=''
                Swal.fire("Success!",'coupon removed','success')
            })
        }
       //placing order
     
       let totalPrice='<%=totalPrice%>'
       let ogTotalPrice=parseFloat(totalPrice)
        placeOrderBtn.addEventListener('click',async function(e){
            e.preventDefault()
            const selectRadio=document.querySelector('input[name="addressRadio"]:checked')
            const paymentOption=document.querySelector('input[name="payment_option"]:checked')
        console.log("payment option selected: ",paymentOption.value);
        
        let selectedAddressId=null
        //make sure new address was added to the user addresses
        if(selectRadio.value==='new'||!selectRadio){
            Swal.fire("Error!","Please select an address or Add new address",'error')
            return
        }
        //storing selected addresses's index
        selectedAddressId=selectRadio.value
        console.log("selected Address index for placing order: ",selectedAddressId);
        placeOrderBtn.disabled=true
        
        //choosing between payments
        if(paymentOption.value=='Online'){
            initiateRazorpayPayment(selectedAddressId,totalPrice,appliedCopounCode)
            placeOrderBtn.innerText='Processing...'
        }else if(paymentOption.value=='COD'||paymentOption.value=='Wallet'){
            placeOrderCOD(selectedAddressId,ogtotalPrice,paymentOption.value,appliedCopounCode)
        }

        //function for Cash on Delivery & Wallet mode
        async function placeOrderCOD(addressId,totalPrice,paymentOption,couponCode) {
        await fetch('/shop/place-order',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                addressId:selectedAddressId,
                totalPrice:totalPrice,
                couponCode:couponCode,
                paymentOption:paymentOption
            })
        }).then(res=>res.json())
        .then(data=>{
            if(data.success){
                Swal.fire('Success!',data.message,'success').then(()=>{
                    window.location.href=`/order-success?orderId=${data.orderId}`
                })
            }else{
                // Swal.fire('Error!',data.message||'Could not place order','error')
                document.getElementById('errorMsg').innerText="*"+data.message||'Could not place order'

            }
        }).catch((err)=>{
            Swal.fire('Error!','Server error & Could not place order','error').then(()=>{
                    window.location.href=`/order-failure`
                })
            console.error("Error in placing order: ",err);
            
        })    
        }
        const razorpayKeyId='<%=razorpayKeyId%>'
        async function initiateRazorpayPayment(addressId,totalPrice,couponCode) {
            try {
                const response=await fetch('/shop/create-razorpay-order',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({totalPrice,addressId,couponCode})
                })
                const orderData=await response.json()
                if(!orderData.success){
                    Swal.fire('Error!','Failed to create an order','error')
                }
                //options for the razorpay window
                const options={
                    "key":'<%=process.env.RAZORPAY_API_TEST_KEY_ID%>',
                    "currency":'INR',
                    "amount":orderData.order.amount,
                    "name":"Ariane Motors",
                    "image":'https://placehold.co/300x300/6001ff/white?text=AM',
                    "description":"Order Payment",
                    "order_id":orderData.order.id,
                    "handler": function (response) {
                        verifyRazorpayPayment(response,orderData.customOrderId)
                    },
                    "prefill":{
                        "name":"<%=user.name%>",
                        "email":"<%=user.email%>",
                        "contact":"<%=user.phone%>"
                    },
                    "theme":{
                        "color":"#088178"
                    }
                }
                //open the razorpay window
                const rzp=new Razorpay(options)

                // Handle payment failure ie if user closes the payment window
                rzp.on('payment.failed',async function (response) {
                    await fetch('/shop/order-failed',{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({order_id:response.error.metadata.order_id})
                    }).then(res=>res.json()).then(result=>{
                        if(result.success){
                            const orderId=result.orderId
                            Swal.fire('Payment Failed!','an error occured','error').then(()=>{
                            window.location.href=`/order-failure?orderId=${orderId}`
                        })
                        }
                    })
                    paymentMessage.innerText = `Payment Failed: ${response.error.description}`;
                    paymentMessage.className = 'mt-4 text-center text-red-600';
                });

                rzp.open()

            } catch (error) {
                console.error('Razorpay error: ',error)
            }finally{
                placeOrderBtn.disabled=false
                placeOrderBtn.innerText='Make Payment'
            }
        }
        //verify the payment in the backend with the key and signature
        async function verifyRazorpayPayment(paymentResponse,orderId) {
            try{
            const response=await fetch('/shop/verify-razorpay-payment',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    orderId:orderId,
                    razorpay_order_id:paymentResponse.razorpay_order_id,
                    razorpay_payment_id:paymentResponse.razorpay_payment_id,
                    razorpay_signature:paymentResponse.razorpay_signature
                })
            })
            if(!response.ok){
                throw new Error("Fetch for verification failed");
                
            }
            const result=await response.json()
            // console.log("result of verification: ",result )
            if(result.success){
                Swal.fire('Payment Successful!',result.message,'success').then(()=>{
                    window.location.href=`/order-success?orderId=${result.orderId}`
                })
            }else{
                Swal.fire('Payment Failed!',result.message,'error')
            }
        }catch(err){
            console.error("error in razorpay payment verify: ",err);
            Swal.fire('Payment Failed!','Server Error','error')
        }
        }
        
       })
       
    })
</script>