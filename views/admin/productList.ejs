<%-include('../partials/admin/header') %>
<style>
    .error-message{
        display: block;
        color: red;
        font-size: small;
    }
</style>
<main>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Product Management </h2>
                    <p>Edit or Delete a product</p>
                </div>
                <!--Search bar-->
                <div>
                  <form action="/admin/products" method="get" class="mb-3 d-flex ">
                    
                    <input type="text" name="search" placeholder="Search Products" class="form-control bg-white" value="<%= search||""  %>">
                    <% if(search){ %>
                      <a href="/admin/products"><button class="btn btn-close" type="button"></button></a>
                      <% }else{ %>
                    <button type="submit" class="btn-primary">Search</button>
                    <% } %>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row d-flex">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                           
                                            <th>#</th>
                                            <th>Product</th>
                                            <th>Brand</th>
                                            <th>Description</th>
                                            <th></th>
                                            <th>Category</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Images</th>
                                            <th>Actions</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody>
                                      <% if(!products){ %>
                                        <h1>No products to display</h1><% }else{ %>
  <% products.forEach((product,index) => { %>
    <tr>
      <td><%= index + 1 %></td>
      <td><%= product.name %></td>
      <td><%= product.brand %></td>
      <td><%= product.productDescription.split(" ").splice(0,15).join(" ") %></td>
      <td></td>
      <td><%= product.category.name%></td>
      <td>â‚¹<%= product.price %></td>
      <td><%= product.quantity %></td>
      <td>
            <img src="<%= product.images[0] %>" width="200" alt="image">
            
      </td>
      <td style="height: 100%;" class="d-flex justify-content-between">
        <button 
          class="btn btn-warning edit-btn"
          data-bs-toggle="modal" 
          data-bs-target="#updateproduct"
          data-id="<%= product._id %>"
          data-name="<%= product.name %>"
          data-brand="<%= product.brand %>"
          data-description="<%= product.productDescription %>"
          data-price="<%= product.price %>"
          data-quantity="<%= product.quantity %>"
          data-category="<%= product.category._id ||product.category%>"
          data-images="<%= product.images %>"
        ><i class="fa fa-pencil"></i>
        </button>
          <button class="btn btn-<%= product.isDeleted?'success':'danger' %> delete-product-btn" data-id="<%= product._id %>" data-deleted="<%= product.isDeleted ?1:0%>" type="submit"><%= product.isDeleted?"Restore":"Delete" %></button>
          
          <button class="btn btn-danger removeBtn"  data-product-id="<%= product._id %>"><i class="fa fa-trash-o"></i></button>
        
      </td>
    </tr>
  <% }) }%>

</tbody>

      </table>
      
  </div>
  </div>
  </div>
  </div>
  </div>
  <!-- Pagination -->
 
  <nav aria-label="Product Pagination" class="mt-4">
    <ul class="pagination justify-content-center">
      
      <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %><%= search ? '&search=' + search : '' %>">Previous</a>
        </li>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
        </li>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %><%= search ? '&search=' + search : '' %>">Next</a>
        </li>
      <% } %>
    </ul>
  </nav>
  </section>
  



                        

 
    </main>
    <!--Edit product Modal -->
<div class="modal fade" id="updateproduct" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="editproductform" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-id" name="id">
          <div class="mb-3">
            <label>Product Name</label>
            <input type="text" class="form-control" name="name" id="edit-product-name" required>
          </div>
          <div class="mb-3">
            <label>Brand Name</label>
            <input type="text" class="form-control" name="brand" id="edit-product-brand">
          </div>
          <div class="mb-3">
            <label>Description</label>
            <input type="text" class="form-control" name="description" id="edit-product-description">
          </div>
          <div class="mb-3">
            <label for="edit-product-category">Category</label>
           <select name="category" id="edit-product-category" class="form-control">
                                <option value="" >--Select Category--</option>
                                
                                <% categories.forEach(cat => { %>
                                    
                                <option value="<%= cat._id %>"><%= cat.name %></option>
                                   <% }) %>
                                 </select>
          </div>
          <div class="mb-3">
            <label>Price</label>
            <input type="number" class="form-control" name="price" id="edit-product-price" required>
          </div>
          <div class="mb-3">
            <label>Quantity</label>
            <input type="number" class="form-control" name="quantity" id="edit-product-quantity">
          </div>
         <div class="mb-3 d-flex">
          <label for="">Existing Images</label>
          <div id="existing-images" class="d-flex flex-wrap gap-2"></div>
         </div>
        <!--File input-->
          <div class="mb-3">
             <label class="form-label">Add New Image(s)</label>
            <input type="file" name="images" id="edit-new-images" multiple accept="image/*" />
          </div>
          <!--Cropping area-->
          <div class="text-center mb-3">
            <img id="cropper-preview" style="max-width: 100%; display: none;" />
          </div>                   
          <!--Cropped Images Preview-->
          <div id="edit-cropped-preview-container" class="d-flex flex-wrap gap-2 mt-2"></div>
        </div>
         <button type="button" class="btn btn-primary" id="crop-next">Crop & Next</button>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-warning">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <script src="/backend/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/backend/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/backend/assets/js/vendors/select2.min.js"></script>
    <script src="/backend/assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/backend/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="/backend/assets/js/main.js" type="text/javascript"></script>
    <!--cropperjs script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>



<script>
 

//edit process & softdelete process
  document.addEventListener("DOMContentLoaded", () => {
    
  

  //=============
 // cropper logic for cropping images in add product & edit product
 //===============


  let cropper
  let selectedFiles = []
  let croppedBlobs = []
  let imageIndex = 0

  const imageInput = document.getElementById('edit-new-images')//file input 
  const imagePreview = document.getElementById('cropper-preview')//field for image Previiew
  const previewContainer = document.getElementById('edit-cropped-preview-container')//previews of cropped images
  const cropNextBtn=document.getElementById('crop-next')

  //Function to load next image for cropping
  function loadNextImage() {
    if (imageIndex >= selectedFiles.length) {
      //if all images are cropped
      if (cropper) cropper.destroy()
      imagePreview.src = ''
      return
    }

    const file = selectedFiles[imageIndex]
    const reader = new FileReader()

    reader.onload = function (event) {
      imagePreview.src = event.target.result
      imagePreview.style.display='block'//show preview when the image is loaded
      //destroy previous cropper if its existing
      if (cropper) cropper.destroy()
      cropper = new Cropper(imagePreview, {
        aspectRatio: 1,//square cropping
        viewMode: 1
      })
    }

    reader.readAsDataURL(file)
  }
  //Initialize the cropper workflow
  function initializeImageCropper(inputElement){
    inputElement.addEventListener('change',function(e){
      selectedFiles=Array.from(e.target.files)//to store the selected files
      imageIndex=0
      croppedBlobs=[]//resets cropped blobs
      previewContainer.innerHTML=''//to clear old cropped previews
      loadNextImage()//start cropping
    })
  }
  //Call the initializer for your file input
initializeImageCropper(imageInput)

  //to handle the cropping of each selected image
  cropNextBtn.addEventListener('click', function () {
    if (!cropper) return;

    cropper.getCroppedCanvas().toBlob(blob => {
      // Store the cropped blob
      croppedBlobs.push(blob)

      // Show a small preview for each image
      const img = document.createElement('img')
      img.src = URL.createObjectURL(blob)
      img.style.width = '80px'
      img.style.margin = '5px'
      previewContainer.appendChild(img)

      imageIndex++
      loadNextImage() // Move to next image
    }, 'image/jpeg')
  });



  //==============
  //Edit product handling
  //==============
    const editButtons = document.querySelectorAll('.edit-btn')
    const form = document.getElementById('editproductform')
    //Populate existing images
    const imagesContainer=document.getElementById('existing-images')
        
    editButtons.forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.id;
        const name = button.dataset.name;
        const description = button.dataset.description;
        const price= button.dataset.price
        const quantity=button.dataset.quantity
        const brand=button.dataset.brand
        const category=button.dataset.category
        const images=button.dataset.images?button.dataset.images.split(','):[]
        

        //  filling the fields
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-product-name').value = name;
        document.getElementById('edit-product-description').value = description;
        document.getElementById('edit-product-price').value=price
        document.getElementById('edit-product-quantity').value=quantity
        document.getElementById('edit-product-brand').value=brand
        document.getElementById('edit-product-category').value=category
        
        
        imagesContainer.innerHTML=""//to clear previous images
        
        images.forEach(img=>{

          const div=document.createElement('div')
          div.classList.add('position-relative','mb-1')

        const image=document.createElement('img')
        image.src=`${img}`
        image.style.width='80px'
        image.style.height='80px'
        image.classList.add('img-thumbnail')
       
        const removeBtn=document.createElement('button')
        removeBtn.textContent='x'
        removeBtn.classList.add('btn','btn-danger','btn-sm','position-absolute')
        removeBtn.style.top='0'
        removeBtn.style.right='0'
        removeBtn.addEventListener('click',()=>{//to remove the image
          
          //removing visually
          div.remove()

          //Add to hidden field for deletion
          const hiddenInput=document.createElement('input')
          hiddenInput.type='hidden'
          hiddenInput.name='removeImages[]'
          hiddenInput.value=img
          form.appendChild(hiddenInput)
        })
        div.appendChild(image)
        div.appendChild(removeBtn)
        imagesContainer.appendChild(div)
         })
        
         // Set form action dynamically
        form.action = `/admin/products/${id}/edit`;
        
      });
    });
 //before submitting the edit form=>we append cropped images to form
 form.addEventListener('submit',async(e)=>{
  if(croppedBlobs.length>0){
    e.preventDefault()

    const formData=new FormData()
    const formElements=Array.from(form.elements)
    formElements.forEach(el=>{
      if(el.name && el.type!=='file'){
        formData.append(el.name,el.value)
      }
    })
    //append only cropped images
    croppedBlobs.forEach((blob,index)=>{
      formData.append('images',blob,`cropped-${Date.now()}-${index}.jpg`)
    })
    try {
      const response=await fetch(form.action,{
        method:'POST',
        body:formData
      })
      if(response.ok){
        Swal.fire('Success!','Product updated sucessfully','success');
        setTimeout(()=>location.reload(),1000)
      }else{
        Swal.fire('Error!','Failed to update product','error')
      }
    } catch (error) {
      console.error('error in submitting edit form',error)
      Swal.fire('Error!','Something went wrong','error')
    }
  }
 })

    //=============
   //Unlisting the product
   //=============
 document.querySelectorAll('.delete-product-btn').forEach(button=>{
  button.addEventListener('click',async()=>{

  const productid=button.dataset.id
  let deleted=Boolean(+button.dataset.deleted)
  
  console.log("isdeleted:",Boolean(deleted))
  // const action = deleted ? "restore":"delete"
  let action 
  if(deleted){
    console.log(deleted)
    action = "restore"
  }else{
        action = "delete"
  }

  console.log("action:",action)

  const result=await Swal.fire({
    title:`Are you sure , You want to ${action} the product`,
    icon:"warning",
    showCancelButton:true,
    confirmButtonColor:deleted?'#3085d6' : '#d33',
    cancelButtonColor:'#aaa',
    confirmButtonText:`Yes!${action} it`
  })
  if(result.isConfirmed){
    try {
      const res=await fetch(`/admin/products/${productid}/delete`,{
        method:'post',
        headers:{
          'Content-Type':'application/json'
        }
      })
      if(res.ok){
        Swal.fire({
          title:`Product ${action}d!`,
          icon:'success',
          timer:1000,
          showConfirmButton:false
        })
        setTimeout(()=>location.reload(),1000)
      }else{
        Swal.fire("Failed!","Something went wrong","error")
      }
    } catch (error) {
      console.log("Error in deleting/restoring the product",error)
    }
  }
 })
 })
 //=========
 //remove the product
 //=========
 const removeBtns=document.querySelectorAll('.removeBtn')
 removeBtns.forEach(btn=>{
  btn.addEventListener('click',async()=>{
    console.log("button clicked");
    const result=await Swal.fire({
      icon:'warning',
      title:'Are You Sure?',
      text:'This action will permenantly delete the product',
      showCancelButton:true,
      confirmButtonText:'Yes,Delete it!'
    })
    if(result.isConfirmed){
      try {
        const productId=btn.dataset.productId
        const response=await fetch(`/product/remove/${productId}`,{
          method:'DELETE',
          headers:{'Content-Type':'application/json'}
        })
        const result=await response.json()
        if(result.success){
          Swal.fire({
            
          })
        }
      } catch (error) {
        
      }
    }
    
  })
 })
  })
</script>

</body>

</html>