<%- include('../partials/admin/header') %>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Categories </h2>
                    <p>Add, edit or delete a category</p>
                </div>
                <div >
                   
                     <!-- Search Bar -->
  <form method="GET" action="/admin/categories" class="mb-3 d-flex">
    <input type="text" name="search" placeholder="Search Categories" class="form-control bg-white" value="<%= search || '' %>">
    
    <button type="submit" class="btn-primary">Search</button>
    <% if (search) { %>
      <a  href="/admin/categories"><button class="btn btn-close" type="button"></button></a>
    <% } %>
  </form>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <form id="categoryForm">
                                <div class="mb-4">
                                    <label for="category_name" class="form-label">Name</label>
                                    <input type="text" name="name" placeholder="New Category" class="form-control" id="category_name" />
                                </div>
                                
                                
                                <div class="mb-4">
                                    <label class="form-label">Description</label>
                                    <textarea name="description" placeholder="Type here" class="form-control"></textarea>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Create category</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-9">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                           
                                            <th>#</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody>
  <% categories.forEach((category, index) => { %>
    <tr>
      <td><%= index + 1 %></td>
      <td><%= category.name %></td>
      <td><%= category.description %></td>
      <td class="d-flex justify-content-center gap-2">
        <button 
          class="btn btn-primary edit-btn"
          data-bs-toggle="modal" 
          data-bs-target="#updatecategory"
          data-id="<%= category._id %>"
          data-name="<%= category.name %>"
          data-description="<%= category.description %>"
        >
          Edit <i class="fa fa-pencil"></i>
        </button>

         <button 
          class="btn toggle-btn <%= category.isDeleted ? 'btn-success' : 'btn-danger' %>"
          data-id="<%= category._id %>"
          data-status="<%= category.isDeleted %>"
        >
          <%= category.isDeleted ? "Restore" : "Delete" %>
        </button>
      </td>
    </tr>
  <% }) %>
</tbody>

      </table>
                                

                   
    </main>
            <!--Edit category Modal -->
<div class="modal fade" id="updatecategory" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editcategoryform">
        <div class="modal-header">
          <h5 class="modal-title">Edit Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-id" name="id">
          <div class="mb-3">
            <label>Category Name</label>
            <input type="text" class="form-control" name="name" id="edit-category-name" required>
          </div>
          <div class="mb-3">
            <label>Description</label>
            <input type="text" class="form-control" name="description" id="edit-category-description">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-warning">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>

    <script src="/backend/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/backend/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/backend/assets/js/vendors/select2.min.js"></script>
    <script src="/backend/assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/backend/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="/backend/assets/js/main.js" type="text/javascript"></script>
</body>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const editButtons = document.querySelectorAll('.edit-btn');
    const editForm = document.getElementById('editcategoryform');
    const toggleButtons=document.querySelectorAll(".toggle-btn")
    document.getElementById('categoryForm').addEventListener("submit",async function (e) {//for addcategory form
      e.preventDefault()
      const formData=new FormData(this)
      const name=formData.get("name").trim()
      const description=formData.get("description")

      const res=await fetch('/admin/categories',{
        method:"post",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name,description})
      })
      const data=await res.json()

      if(data.success){
        Swal.fire({
          icon:"success",
          title:"Category Added",
          text:data.message,
        }).then(()=>location.reload())
      }else{
        Swal.fire({
          icon:"error",
          title:"Error",
          text:data.message
        })
      }
      
    })
//edit category
    editButtons.forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.id;
        const name = button.dataset.name;
        const description = button.dataset.description;

        //  filling the fields
        // document.getElementById('edit-id').value = id;
        document.getElementById('edit-category-name').value = name;
        document.getElementById('edit-category-description').value = description;

        editForm.addEventListener('submit',async function (e) {
          e.preventDefault()
          const formData=new FormData(editForm)  
          const data=Object.fromEntries(formData.entries())     
         try {
           const response=await fetch(`/admin/categories/${id}/edit`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(data)
          })
            const result=await response.json()
            const updated=result.category
            if(result.success){
              Swal.fire('Success!',result.message,'success')
              //find the row
              const row=document.querySelector(`button.edit-btn[data-id="${updated._id}"]`).closest("tr")
              //update cells
              row.querySelector('td:nth-child(2)').textContent=updated.name
              row.querySelector('td:nth-child(3)').textContent=updated.description

              const editBtn=row.querySelector('.edit-btn')
              editBtn.dataset.name=updated.name
              editBtn.dataset.description=updated.description
              console.log("category updated");
            }else{
              Swal.fire('Error!',result.message,'error')
            }
         } catch (error) {
          console.log(error)
          Swal.fire('Error!','Server Error','error')
         }

        })
      });
    });

    //for delete and restore category
    toggleButtons.forEach(button => {
    button.addEventListener("click", async function () {
      const id = this.getAttribute("data-id");
      const currentStatus = this.getAttribute("data-status") === "true";
      const actionText = currentStatus ? "restore" : "delete";

      Swal.fire({
        title: `Are you sure you want to ${actionText} this category?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: `Yes, ${actionText} it!`,
      }).then(async (result) => {
        if (result.isConfirmed) {
          const res = await fetch(`/admin/categories/${id}/delete`, {
            method: "PATCH"
          });
          const data = await res.json();

          if (data.success) {
            // Update button instantly without reload
            this.textContent = data.isDeleted ? "Restore" : "Delete";
            this.classList.toggle("btn-danger", !data.isDeleted);
            this.classList.toggle("btn-success", data.isDeleted);
            this.setAttribute("data-status", data.isDeleted);

            Swal.fire({
              icon: "success",
              title: data.message
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.message
            });
          }
        }
      })
    })
  });
})
</script>

</html>